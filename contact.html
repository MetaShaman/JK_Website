<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact - Joon Kim Land Stewardship</title>
    <meta name="description" content="Get in touch with Joon Kim to discuss your land stewardship and project management needs. Schedule a complimentary consultation.">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">Joon Kim</a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">Home</a>
                </li>
                <li class="nav-item">
                    <a href="services.html" class="nav-link">Services</a>
                </li>
                <li class="nav-item">
                    <a href="about.html" class="nav-link">About</a>
                </li>
                <li class="nav-item">
                    <a href="contact.html" class="nav-link active">Contact</a>
                </li>
            </ul>
            <div class="nav-toggle" id="mobile-menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1>Let's Connect</h1>
            <p>I'm eager to learn about your land and discuss how my services can help you achieve your goals. Please feel free to reach out using the contact information below, or fill out the form to schedule a complimentary consultation.</p>
        </div>
    </section>

    <!-- Contact Content -->
    <section class="contact-content">
        <div class="container">
            <div class="contact-grid">
                <!-- Contact Information -->
                <div class="contact-info">
                    <h2>Contact Information</h2>
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">
                            <h3>Email</h3>
                            <p>ivanjoonkim@gmail.com</p>
                        </div>
                    </div>
                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="contact-details">
                            <h3>Location</h3>
                            <p>315 Margarita Dr.<br>San Rafael, CA 94901</p>
                        </div>
                    </div>
                    
                    <!-- Service Areas -->
                    <div class="service-areas">
                        <h3>Service Areas</h3>
                        <p>Based in San Rafael, I primarily serve properties in Northern California, with extensive experience in:</p>
                        <ul>
                            <li>Marin County</li>
                            <li>Sonoma County</li>
                            <li>Napa County</li>
                            <li>San Francisco Bay Area</li>
                        </ul>
                        <p class="note">For properties outside these areas, please contact me to discuss availability.</p>
                    </div>
                </div>

                <!-- Contact Form -->
                <div class="contact-form">
                    <h2>Send Me a Message</h2>
                    <form id="contactForm" action="https://docs.google.com/forms/d/e/1FAIpQLSf76wgQZ6fUxB7f2Zt1Ppjw1hlQcoKqmk4Yn0O2R5Qmy9UHJA/formResponse" method="POST" target="_blank">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="emailAddress" required>
                        </div>
                        <div class="form-group">
                            <label for="landLove">What is one thing that you love about your land?</label>
                            <input type="text" id="landLove" name="entry.428724634" placeholder="Tell me about your favorite aspect of your land">
                        </div>
                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <input type="text" id="name" name="entry.641543091" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="entry.1764103006">
                        </div>
                        <div class="form-group">
                            <label for="property-location">Land Location</label>
                            <input type="text" id="property-location" name="entry.1531760759" placeholder="City, State">
                        </div>
                        <div class="form-group">
                            <label for="property-size">Land Size</label>
                            <select id="property-size" name="entry.789863818">
                                <option value="">Select land size</option>
                                <option value="Under 1 acre">Under 1 acre</option>
                                <option value="1-5 acres">1-5 acres</option>
                                <option value="5-10 acres">5-10 acres</option>
                                <option value="10+ acres">10+ acres</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="services-interest">Services of Interest</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="entry.911095196" value="Structural Repairs & Maintenance">
                                    Structural Repairs & Maintenance
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="entry.911095196" value="Landscape & Garden Projects">
                                    Landscape & Garden Projects
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="entry.911095196" value="Design Support & Implementation">
                                    Design Support & Implementation
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="entry.911095196" value="Project Tracking & Oversight">
                                    Project Tracking & Oversight
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="entry.911095196" value="Regulatory Compliance & Permitting">
                                    Regulatory Compliance & Permitting
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="timeline">Project Timeline</label>
                            <select id="timeline" name="entry.847273278">
                                <option value="">Select timeline</option>
                                <option value="Immediate (within 1 month)">Immediate (within 1 month)</option>
                                <option value="Short-term (1-3 months)">Short-term (1-3 months)</option>
                                <option value="Medium-term (3-6 months)">Medium-term (3-6 months)</option>
                                <option value="Long-term (6+ months)">Long-term (6+ months)</option>
                                <option value="Ongoing stewardship">Ongoing stewardship</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="message">Current Challenges and Goals *</label>
                            <textarea id="message" name="entry.771214362" rows="5" placeholder="Please describe your current land challenges and goals." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="contact-method">Preferred Contact Method *</label>
                            <select id="contact-method" name="entry.2117189622" required>
                                <option value="">Select contact method</option>
                                <option value="Email">Email</option>
                                <option value="Phone Call">Phone Call</option>
                                <option value="Video call (Zoom/Google Meet)">Video call (Zoom/Google Meet)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="best-time">Best Time to Contact</label>
                            <select id="best-time" name="entry.2015429434">
                                <option value="">Select best time</option>
                                <option value="Morning (9 AM - 12 PM)">Morning (9 AM - 12 PM)</option>
                                <option value="Afternoon (12 PM - 5 PM)">Afternoon (12 PM - 5 PM)</option>
                                <option value="Evening (5 PM - 8 PM)">Evening (5 PM - 8 PM)</option>
                            </select>
                        </div>
                        
                        <!-- Consultation Preference Section -->
                        <div class="form-group">
                            <label class="form-label-required">Consultation Preference *</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="consultationType" value="discovery_call" required>
                                    <span class="radio-custom"></span>
                                    Schedule a 15 minute discovery call
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="consultationType" value="email_only" required>
                                    <span class="radio-custom"></span>
                                    Not ready to book a call now
                                </label>
                            </div>
                            <small class="form-help-text">💡 Discovery calls help us better understand your specific needs and provide tailored recommendations.</small>
                        </div>
                        
                        <!-- Calendly Widget Container (hidden by default) -->
                        <div id="calendly-container" class="calendly-container" style="display: none;">
                            <div class="calendly-header">
                                <h3>📅 Schedule Your 15-Minute Discovery Call</h3>
                                <p>Choose a time that works best for you. This will be a 15-minute complimentary discovery call to discuss your land stewardship needs and goals.</p>
                                <div class="calendly-instructions">
                                    <div class="instruction-step">
                                        <span class="step-number">1</span>
                                        <span>Fill out the form above with your project details</span>
                                    </div>
                                    <div class="instruction-step">
                                        <span class="step-number">2</span>
                                        <span>Schedule your discovery call below</span>
                                    </div>
                                    <div class="instruction-step">
                                        <span class="step-number">3</span>
                                        <span>Submit the form to send your information</span>
                                    </div>
                                </div>
                            </div>
                            <div class="calendly-inline-widget" data-url="https://calendly.com/joonkim_schedule/land-stewardship-discovery-call?prefill[email]=&prefill[name]=&prefill[first_name]=&prefill[last_name]=&prefill[phone]=&prefill[location]=&prefill[note]=" style="min-width:320px;height:700px;"></div>
                            <div id="call-scheduled-status" class="call-status" style="display: none;">
                                <div class="status-success">
                                    <i class="fas fa-check-circle"></i>
                                    <span>✅ Discovery call scheduled successfully!</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden field to track call scheduling -->
                        <input type="hidden" id="call-scheduled" name="callScheduled" value="false">
                        
                        <!-- Hidden fields for Calendly booking data -->
                        <input type="hidden" id="appointment-booked" name="entry.905794834" value="No">
                        <input type="hidden" id="appointment-type" name="entry.1099853613" value="">
                        <input type="hidden" id="appointment-date" name="entry.507706455" value="">
                        <input type="hidden" id="appointment-time" name="entry.836387002" value="">
                        <input type="hidden" id="appointment-info" name="entry.1480507405" value="">
                        
                        <button type="submit" class="btn btn-primary">Send Message</button>
                        
                        <!-- Debug button for testing -->
                        <button type="button" class="btn btn-secondary" style="margin-left: 10px; font-size: 12px;" onclick="simulateCallScheduled()">Test: Simulate Call Scheduled</button>
                        <button type="button" class="btn btn-secondary" style="margin-left: 10px; font-size: 12px;" onclick="testCalendlyListener()">Test: Check Calendly</button>
                        <button type="button" class="btn btn-secondary" style="margin-left: 10px; font-size: 12px;" onclick="manualBookingComplete()">Manual: Set Booking State</button>

                        <!-- Manual trigger button for testing
                        <button type="button" class="btn btn-warning btn-sm" onclick="markCallAsScheduled({ source: 'manual test' })">🔧 Test: Simulate Call Booking</button> -->
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Joon Kim</h3>
                    <p>Land Stewardship & Project Management</p>
                    <p>San Rafael, CA</p>
                </div>
                <div class="footer-section">
                    <h4>Services</h4>
                    <ul>
                        <li><a href="services.html">Building & Infrastructure</a></li>
                        <li><a href="services.html">Land & Garden Projects</a></li>
                        <li><a href="services.html">Design & Implementation</a></li>
                        <li><a href="services.html">Oversight & Compliance</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p><i class="fas fa-envelope"></i> ivanjoonkim@gmail.com</p>
                    <p><i class="fas fa-map-marker-alt"></i> 315 Margarita Dr., San Rafael, CA 94901</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Joon Kim. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Calendly Integration -->
    <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
    <script>
        // Clear any existing Calendly functions to prevent conflicts
        if (window.checkCalendlyLoaded) {
            delete window.checkCalendlyLoaded;
        }
        if (window.initCalendlyListener) {
            delete window.initCalendlyListener;
        }
        
        // Toggle Calendly widget when radio button is selected
        document.addEventListener('DOMContentLoaded', function() {
            const consultationTypeRadios = document.querySelectorAll('input[name="consultationType"]');
            const calendlyContainer = document.getElementById('calendly-container');
            const contactForm = document.getElementById('contactForm');
            const callScheduledField = document.getElementById('call-scheduled');
            const callScheduledStatus = document.getElementById('call-scheduled-status');
            
            // Function to handle radio button changes
            function handleConsultationPreference() {
                const selectedValue = document.querySelector('input[name="consultationType"]:checked')?.value;
                
                if (selectedValue === 'discovery_call') {
                    calendlyContainer.style.display = 'block';
                    // Reset call scheduled status when switching to call option
                    callScheduledField.value = 'false';
                    callScheduledStatus.style.display = 'none';
                    // Smooth scroll to the Calendly widget
                    calendlyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    calendlyContainer.style.display = 'none';
                    callScheduledField.value = 'false';
                    callScheduledStatus.style.display = 'none';
                }
            }
            
            // Add event listeners for radio buttons
            consultationTypeRadios.forEach(radio => {
                radio.addEventListener('change', handleConsultationPreference);
            });
            
            // Function to mark call as scheduled and update form fields
            function markCallAsScheduled(eventData) {
                console.log('🎯 Marking call as scheduled with data:', eventData);
                console.log('📊 Full event data structure:', JSON.stringify(eventData, null, 2));
                
                // Update hidden fields with booking data
                const appointmentBooked = document.getElementById('appointment-booked');
                const appointmentType = document.getElementById('appointment-type');
                const appointmentDate = document.getElementById('appointment-date');
                const appointmentTime = document.getElementById('appointment-time');
                const appointmentInfo = document.getElementById('appointment-info');
                
                if (appointmentBooked) {
                    appointmentBooked.value = 'Yes';
                    console.log('✅ Appointment booked set to Yes');
                }
                if (appointmentType) {
                    appointmentType.value = 'Land Stewardship Discovery Call';
                    console.log('✅ Appointment type set');
                }
                
                // Try multiple ways to extract date and time from the event
                let startTime = null;
                let eventDetails = null;
                
                // Method 1: Standard Calendly event structure
                if (eventData && eventData.data && eventData.data.payload && eventData.data.payload.event) {
                    eventDetails = eventData.data.payload.event;
                    console.log('📅 Found event details in data.payload.event:', eventDetails);
                }
                // Method 2: Direct event structure
                else if (eventData && eventData.payload && eventData.payload.event) {
                    eventDetails = eventData.payload.event;
                    console.log('📅 Found event details in payload.event:', eventDetails);
                }
                // Method 3: Direct event data
                else if (eventData && eventData.event) {
                    eventDetails = eventData.event;
                    console.log('📅 Found event details in event:', eventDetails);
                }
                // Method 4: Check for start_time directly
                else if (eventData && eventData.start_time) {
                    startTime = new Date(eventData.start_time);
                    console.log('📅 Found start_time directly:', startTime);
                }
                
                // Extract start time from event details
                if (eventDetails) {
                    if (eventDetails.start_time) {
                        startTime = new Date(eventDetails.start_time);
                        console.log('📅 Extracted start_time from event details:', startTime);
                    } else if (eventDetails.startTime) {
                        startTime = new Date(eventDetails.startTime);
                        console.log('📅 Extracted startTime from event details:', startTime);
                    } else if (eventDetails.date) {
                        startTime = new Date(eventDetails.date);
                        console.log('📅 Extracted date from event details:', startTime);
                    }
                }
                
                // Set date and time if we found them
                if (startTime && !isNaN(startTime.getTime())) {
                    if (appointmentDate) {
                        appointmentDate.value = startTime.toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        console.log('✅ Appointment date set:', appointmentDate.value);
                    }
                    
                    if (appointmentTime) {
                        appointmentTime.value = startTime.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            timeZoneName: 'short'
                        });
                        console.log('✅ Appointment time set:', appointmentTime.value);
                    }
                } else {
                    // Set default values if no date/time found
                    if (appointmentDate) {
                        appointmentDate.value = 'Scheduled via Calendly';
                        console.log('⚠️ No date found, using default');
                    }
                    if (appointmentTime) {
                        appointmentTime.value = 'Scheduled via Calendly';
                        console.log('⚠️ No time found, using default');
                    }
                }
                
                // Set appointment info
                if (appointmentInfo) {
                    const info = [];
                    if (eventDetails) {
                        if (eventDetails.name) info.push(`Event: ${eventDetails.name}`);
                        if (eventDetails.duration) info.push(`Duration: ${eventDetails.duration} minutes`);
                        if (eventDetails.location) info.push(`Location: ${eventDetails.location}`);
                        if (eventDetails.description) info.push(`Description: ${eventDetails.description}`);
                    }
                    if (info.length === 0) {
                        info.push('Land Stewardship Discovery Call - Scheduled via Calendly');
                    }
                    appointmentInfo.value = info.join(' | ');
                    console.log('✅ Appointment info set:', appointmentInfo.value);
                }
                
                callScheduledField.value = 'true';
                callScheduledStatus.style.display = 'block';
                callScheduledStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });
                console.log('✅ Call scheduled field set to true');
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.className = 'alert alert-success';
                successMessage.innerHTML = '<strong>✅ Call Scheduled!</strong> Your discovery call has been booked. You can now submit the form.';
                callScheduledStatus.appendChild(successMessage);
                
                // Manual trigger button for testing
                const manualTriggerBtn = document.createElement('button');
                manualTriggerBtn.type = 'button';
                manualTriggerBtn.className = 'btn btn-warning btn-sm';
                manualTriggerBtn.style.marginTop = '10px';
                manualTriggerBtn.textContent = '🔧 Test: Simulate Call Booking';
                manualTriggerBtn.onclick = function() {
                    console.log('🧪 Manual trigger: Simulating call booking...');
                    markCallAsScheduled({ source: 'manual test' });
                };
                callScheduledStatus.appendChild(manualTriggerBtn);
            }
            
            // Function to set up Calendly event listener
            function setupCalendlyListener() {
                console.log('🔧 Setting up Calendly listener...');
                console.log('- window.Calendly exists:', !!window.Calendly);
                console.log('- window.Calendly type:', typeof window.Calendly);
                
                // More robust check for Calendly readiness
                if (window.Calendly && typeof window.Calendly === 'function' && window.Calendly.initInlineWidget) {
                    console.log('✅ Calendly is ready, setting up listeners...');
                    // Wait a bit more for the widget to be fully initialized
                    setTimeout(function() {
                        try {
                            // Set up the main event listener
                            window.Calendly('onEventScheduled', function(e) {
                                console.log('🎉 Calendly event scheduled:', e);
                                markCallAsScheduled(e);
                            });
                            
                            // Set up additional event listeners for debugging
                            window.Calendly('onProfilePageViewed', function(e) {
                                console.log('📊 Calendly profile page viewed:', e);
                            });
                            
                            window.Calendly('onDateAndTimeSelected', function(e) {
                                console.log('📅 Calendly date/time selected:', e);
                                // This might be the key event we need
                                markCallAsScheduled(e);
                            });
                            
                            window.Calendly('onEventTypeViewed', function(e) {
                                console.log('👀 Calendly event type viewed:', e);
                            });
                            
                            // Try to listen for ALL possible Calendly events
                            try {
                                // Listen for any Calendly events using a more generic approach
                                if (window.Calendly && typeof window.Calendly === 'function') {
                                    // Try to hook into the Calendly function itself
                                    const originalCalendly = window.Calendly;
                                    window.Calendly = function(eventType, callback) {
                                        console.log('🎯 Calendly event listener registered:', eventType);
                                        return originalCalendly.call(this, eventType, function(e) {
                                            console.log('🎯 Calendly event fired:', eventType, e);
                                            if (eventType === 'onEventScheduled' || eventType === 'onDateAndTimeSelected') {
                                                markCallAsScheduled(e);
                                            }
                                            return callback(e);
                                        });
                                    };
                                    console.log('✅ Calendly function hooked for event monitoring');
                                }
                            } catch (error) {
                                console.error('❌ Error hooking Calendly function:', error);
                            }
                            
                            // Listen for any Calendly events
                            if (window.Calendly.EVENT_TYPES) {
                                console.log('📋 Available Calendly event types:', window.Calendly.EVENT_TYPES);
                            }
                            
                            // Set up DOM mutation observer to detect booking completion
                            const calendlyContainer = document.querySelector('.calendly-inline-widget');
                            if (calendlyContainer) {
                                const observer = new MutationObserver(function(mutations) {
                                    mutations.forEach(function(mutation) {
                                        if (mutation.type === 'childList') {
                                            mutation.addedNodes.forEach(function(node) {
                                                if (node.nodeType === 1) { // Element node
                                                    // Look for success messages or confirmation elements
                                                    if (node.textContent && (
                                                        node.textContent.includes('confirmed') ||
                                                        node.textContent.includes('scheduled') ||
                                                        node.textContent.includes('booked') ||
                                                        node.textContent.includes('appointment') ||
                                                        node.textContent.includes('success')
                                                    )) {
                                                        console.log('🎯 Detected booking confirmation in DOM:', node.textContent);
                                                        markCallAsScheduled({ source: 'DOM mutation' });
                                                    }
                                                }
                                            });
                                        }
                                    });
                                });
                                
                                observer.observe(calendlyContainer, {
                                    childList: true,
                                    subtree: true,
                                    characterData: true
                                });
                                console.log('👁️ DOM mutation observer set up for Calendly container');
                            }
                            
                            // Listen for iframe messages from Calendly
                            window.addEventListener('message', function(event) {
                                if (event.origin.includes('calendly.com')) {
                                    console.log('📨 Received message from Calendly:', event.data);
                                    if (event.data && (
                                        event.data.type === 'calendly:event_scheduled' ||
                                        event.data.type === 'calendly:date_and_time_selected' ||
                                        event.data.type === 'calendly:booking_confirmed'
                                    )) {
                                        console.log('🎯 Detected Calendly booking event via message:', event.data);
                                        markCallAsScheduled(event.data);
                                    }
                                }
                            });
                            
                            // Monitor URL changes in the Calendly iframe
                            const calendlyIframe = document.querySelector('.calendly-inline-widget iframe');
                            if (calendlyIframe) {
                                console.log('🔍 Found Calendly iframe, monitoring for changes...');
                                
                                // Check iframe URL periodically
                                const checkIframeUrl = setInterval(function() {
                                    try {
                                        const currentUrl = calendlyIframe.src;
                                        if (currentUrl && (
                                            currentUrl.includes('confirmed') ||
                                            currentUrl.includes('success') ||
                                            currentUrl.includes('thank') ||
                                            currentUrl.includes('complete')
                                        )) {
                                            console.log('🎯 Detected booking completion via iframe URL:', currentUrl);
                                            markCallAsScheduled({ source: 'iframe URL change', url: currentUrl });
                                            clearInterval(checkIframeUrl);
                                        }
                                    } catch (error) {
                                        // Cross-origin restrictions might prevent access
                                        console.log('⚠️ Cannot access iframe URL due to CORS');
                                    }
                                }, 2000); // Check every 2 seconds
                                
                                // Stop checking after 5 minutes
                                setTimeout(function() {
                                    clearInterval(checkIframeUrl);
                                    console.log('⏰ Stopped monitoring iframe URL changes');
                                }, 300000);
                            }
                            
                            // Add a fallback: check for booking completion every 5 seconds
                            const bookingCheckInterval = setInterval(function() {
                                const calendlyContainer = document.querySelector('.calendly-inline-widget');
                                if (calendlyContainer) {
                                    const successElements = calendlyContainer.querySelectorAll('*');
                                    successElements.forEach(function(element) {
                                        if (element.textContent && (
                                            element.textContent.includes('confirmed') ||
                                            element.textContent.includes('scheduled') ||
                                            element.textContent.includes('booked') ||
                                            element.textContent.includes('appointment') ||
                                            element.textContent.includes('success') ||
                                            element.textContent.includes('thank you')
                                        )) {
                                            console.log('🎯 Detected booking completion via text content:', element.textContent);
                                            markCallAsScheduled({ source: 'text content detection', text: element.textContent });
                                            clearInterval(bookingCheckInterval);
                                        }
                                    });
                                }
                            }, 5000); // Check every 5 seconds
                            
                            // Stop checking after 10 minutes
                            setTimeout(function() {
                                clearInterval(bookingCheckInterval);
                                console.log('⏰ Stopped periodic booking completion checks');
                            }, 600000);
                            
                            console.log('✅ Calendly event listener set up successfully');
                        } catch (error) {
                            console.error('❌ Error setting up Calendly listeners:', error);
                            // Retry after a delay
                            setTimeout(setupCalendlyListenerWithRetry, 1000);
                        }
                    }, 3000); // Wait 3 seconds for widget to be fully loaded
                } else {
                    // If Calendly isn't loaded yet or isn't a function, try again in a moment
                    console.log('⏳ Waiting for Calendly to be ready... (exists:', !!window.Calendly, ', is function:', typeof window.Calendly === 'function', ')');
                    setTimeout(setupCalendlyListenerWithRetry, 1000);
                }
            }
            
            // Start trying to set up Calendly listener
            let retryCount = 0;
            const maxRetries = 10;
            
            function setupCalendlyListenerWithRetry() {
                if (retryCount >= maxRetries) {
                    console.log('❌ Max retries reached for Calendly setup. Using manual booking only.');
                    return;
                }
                retryCount++;
                setupCalendlyListener();
            }
            
            setupCalendlyListenerWithRetry();
            
            // Test Calendly loading
            setTimeout(function() {
                console.log('🔍 Calendly loading check:');
                console.log('- window.Calendly exists:', !!window.Calendly);
                console.log('- window.Calendly type:', typeof window.Calendly);
                console.log('- window.Calendly is function:', typeof window.Calendly === 'function');
                console.log('- Calendly widget element:', document.querySelector('.calendly-inline-widget'));
                console.log('- Calendly container visible:', calendlyContainer.style.display !== 'none');
            }, 3000);
            
            // Function to simulate call scheduled for testing
            window.simulateCallScheduled = function() {
                console.log('🧪 Simulating call scheduled...');
                callScheduledField.value = 'true';
                document.getElementById('appointment-booked').value = 'Yes';
                document.getElementById('appointment-type').value = 'Land Stewardship Discovery Call';
                document.getElementById('appointment-date').value = 'Monday, January 15, 2024';
                document.getElementById('appointment-time').value = '2:00 PM PST';
                document.getElementById('appointment-info').value = 'Event: Land Stewardship Discovery Call | Duration: 15 minutes | Location: Video Call';
                callScheduledStatus.style.display = 'block';
                console.log('✅ Call scheduled simulation complete!');
            };
            
            // Function to test Calendly event listener
            window.testCalendlyListener = function() {
                console.log('🧪 Testing Calendly event listener...');
                console.log('- window.Calendly exists:', !!window.Calendly);
                console.log('- window.Calendly is function:', typeof window.Calendly === 'function');
                
                if (window.Calendly && typeof window.Calendly === 'function') {
                    console.log('✅ Calendly is available and ready');
                    // Try to manually trigger the event listener
                    const testEvent = {
                        data: {
                            payload: {
                                event: {
                                    name: 'Test Event',
                                    start_time: new Date().toISOString(),
                                    duration: 15,
                                    location: 'Video Call'
                                }
                            }
                        }
                    };
                    console.log('🎯 Manually triggering Calendly event...');
                    // This won't actually trigger the listener, but it helps us debug
                    console.log('Test event data:', testEvent);
                } else {
                    console.log('❌ Calendly is not available or not ready');
                    console.log('  - Exists:', !!window.Calendly);
                    console.log('  - Type:', typeof window.Calendly);
                }
            };
            
            // Function to manually set booking state after Calendly booking
            window.manualBookingComplete = function() {
                console.log('🔧 Manually setting booking state...');
                callScheduledField.value = 'true';
                document.getElementById('appointment-booked').value = 'Yes';
                document.getElementById('appointment-type').value = 'Land Stewardship Discovery Call';
                document.getElementById('appointment-date').value = 'Booked via Calendly';
                document.getElementById('appointment-time').value = 'Booked via Calendly';
                document.getElementById('appointment-info').value = 'Event: Land Stewardship Discovery Call | Duration: 15 minutes | Location: Video Call';
                callScheduledStatus.style.display = 'block';
                console.log('✅ Manual booking state set!');
            };
            
            // Form submission validation
            if (contactForm) {
                contactForm.addEventListener('submit', function(e) {
                    console.log('📝 Form submission started');
                    
                    const selectedValue = document.querySelector('input[name="consultationType"]:checked')?.value;
                    const isSchedulingSelected = selectedValue === 'discovery_call';
                    const isCallScheduled = callScheduledField.value === 'true';
                    
                    console.log('📊 Form state:', {
                        selectedValue: selectedValue,
                        isSchedulingSelected: isSchedulingSelected,
                        isCallScheduled: isCallScheduled,
                        callScheduledFieldValue: callScheduledField.value
                    });
                    
                    if (isSchedulingSelected && !isCallScheduled) {
                        console.log('❌ Form submission blocked - call not scheduled');
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        alert('⚠️ Please schedule your discovery call before submitting the form.\n\nYou selected to schedule a call, but no call has been scheduled yet. Please complete your booking in the calendar above, or change your preference to "Not ready to book a call now" if you prefer to communicate via email only.');
                        calendlyContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        return false;
                    }
                    
                    // Show confirmation dialog
                    let confirmMessage = 'Ready to submit your information?';
                    if (isSchedulingSelected && isCallScheduled) {
                        confirmMessage = 'Perfect! You\'ve scheduled your discovery call and filled out the form. Ready to submit?\n\nClick OK to send your information, or Cancel to review.';
                    }
                    
                    const shouldSubmit = confirm(confirmMessage);
                    console.log('✅ User confirmed submission:', shouldSubmit);
                    
                    if (!shouldSubmit) {
                        console.log('❌ User cancelled submission');
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    console.log('🚀 Form submission proceeding to Google Forms...');
                    
                    // Let the form submit normally to Google Forms in a new tab
                    // The form will open in a new tab where the user can complete submission
                    
                    setTimeout(function() {
                        showSubmissionSuccess();
                    }, 2000); // Give time for the new tab to open
                });
            }
            
            // Function to show submission success
            function showSubmissionSuccess() {
                const contactFormContainer = document.querySelector('.contact-form');
                const selectedValue = document.querySelector('input[name="consultationType"]:checked')?.value;
                const isSchedulingSelected = selectedValue === 'discovery_call';
                
                let successMessage = `
                    <div class="submission-success">
                        <div class="success-content">
                            <i class="fas fa-check-circle"></i>
                            <h2>Thank You!</h2>
                            <p>Your message has been sent successfully. I'll get back to you within 24 hours.</p>
                        </div>
                    </div>
                `;
                
                if (isSchedulingSelected) {
                    successMessage = `
                        <div class="submission-success">
                            <div class="success-content">
                                <i class="fas fa-check-circle"></i>
                                <h2>Thank You!</h2>
                                <p>Your message has been sent and your discovery call has been scheduled. I'll send you a confirmation email with the call details.</p>
                                <p>I look forward to discussing your land stewardship needs!</p>
                            </div>
                        </div>
                    `;
                }
                
                contactFormContainer.innerHTML = successMessage;
            }
        });
    </script>
</body>
</html>

